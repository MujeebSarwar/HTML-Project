class TimeMe{constructor(){if(TimeMe.instance)return TimeMe.instance;this.idleTimeoutMs=3e4,this.currentIdleTimeMs=0,this.checkIdleStateRateMs=250,this.isUserCurrentlyOnPage=!0,this.isUserCurrentlyIdle=!1,this.currentPageName="default-page-name",this.visibilityChangeEventName=void 0,this.hiddenPropName=void 0,this.initialize=this.initialize.bind(this),this.triggerUserHasLeftThePage=this.triggerUserHasLeftThePage.bind(this),this.triggerUserHasGoneIdle=this.triggerUserHasGoneIdle.bind(this),TimeMe.instance=this}startTimer(e,t){e||(e=this.currentPageName);let i=localStorage.getItem("startStopTimes")||"{}";if(i=JSON.parse(i),void 0===i[e])i[e]=[];else{let t=i[e],s=t[t.length-1];if(void 0!==s&&void 0===s.stopTime)return}i[e].push({startTime:t||new Date,stopTime:void 0}),localStorage.setItem("startStopTimes",JSON.stringify(i))}stopTimer(e,t){e||(e=this.currentPageName);let i=localStorage.getItem("startStopTimes")||"{}";i=JSON.parse(i);let s=i[e];void 0!==s&&0!==s.length&&(void 0===s[s.length-1].stopTime&&(s[s.length-1].stopTime=t||new Date),i[e]=s,localStorage.setItem("startStopTimes",JSON.stringify(i)))}stopAllTimers(){let e=localStorage.getItem("startStopTimes")||"{}";e=JSON.parse(e);let t=Object.keys(e);for(let e=0;e<t.length;e++)this.stopTimer(t[e])}getTimeOnCurrentPageInSeconds(){return this.getTimeOnPageInSeconds(this.currentPageName)}getTimeOnPageInSeconds(e){const t=this.getTimeOnPageInMilliseconds(e);return void 0===t?void 0:t/1e3}getTimeOnCurrentPageInMilliseconds(){return this.getTimeOnPageInMilliseconds(this.currentPageName)}getTimeOnPageInMilliseconds(e){let t=0,i=localStorage.getItem("startStopTimes")||"{}";i=JSON.parse(i);const s=i[e];if(void 0===s)return;let n=0;for(let e=0;e<s.length;e++){const t=s[e].startTime;let i=s[e].stopTime;void 0===i&&(i=new Date);n+=Date.parse(i)-Date.parse(t)}return t=Number(n),t}getTimeOnAllPagesInSeconds(){let e=[],t=localStorage.getItem("startStopTimes")||"{}";t=JSON.parse(t);let i=Object.keys(t);for(let t=0;t<i.length;t++){let s=i[t],n=this.getTimeOnPageInSeconds(s);e.push({pageName:s,timeOnPage:n})}return e}setIdleDurationInSeconds(e){let t=parseFloat(e);if(!1!==isNaN(t))throw{name:"InvalidDurationException",message:"An invalid duration time ("+e+") was provided."};this.idleTimeoutMs=1e3*e}setCurrentPageName(e){this.currentPageName=e}triggerUserHasGoneIdle(){if(this.isUserCurrentlyOnPage){this.isUserCurrentlyOnPage=!1;let e=localStorage.getItem("userLeftCallbacks")||"[]";e=JSON.parse(e);for(let t=0;t<e.length;t++){let i=e[t],s=i.numberOfTimesToInvoke;(isNaN(s)||void 0===s||s>0)&&(i.numberOfTimesToInvoke-=1,i.callback()),e[t]=i}localStorage.setItem("userLeftCallbacks",JSON.stringify(e))}this.stopAllTimers()}triggerUserHasLeftThePage(){let e=localStorage.getItem("pageViewEvents")||"{}";e=JSON.parse(e);let t=e[this.currentPageName];const i=e.expireTime,s=(new Date).getTime();if(void 0!==t){{t.time_spent=this.getTimeOnCurrentPageInSeconds();const e={request:encrypt([t])},i={headers:{"Content-Type":"application/json",Accept:"application/json","x-api-key":"ASNK5ikSal2KNZTqNBxIT7bUb84PDaOY5oAkH2G5","x-yotpo-client":"shopify-web-pixel"},method:"POST",cache:"no-cache",body:JSON.stringify(e),keepalive:!0,mode:"cors"};fetch("https://web-tracker.smsbump.com",i).then((e=>{})).then().catch((e=>{console.log({status:"error",message:"Something went wrong",error:e})}))}void 0!==i&&s>i?deleteAllData():this.stopAllTimers()}}listenForVisibilityEvents(e,t){e&&this.listenForUserLeavesOrReturnsEvents(),t&&this.listForIdleEvents()}listenForUserLeavesOrReturnsEvents(){"undefined"!=typeof document&&(void 0!==document.hidden?(this.hiddenPropName="hidden",this.visibilityChangeEventName="visibilitychange"):void 0!==document.mozHidden?(this.hiddenPropName="mozHidden",this.visibilityChangeEventName="mozvisibilitychange"):void 0!==document.msHidden?(this.hiddenPropName="msHidden",this.visibilityChangeEventName="msvisibilitychange"):void 0!==document.webkitHidden&&(this.hiddenPropName="webkitHidden",this.visibilityChangeEventName="webkitvisibilitychange"),document.addEventListener(this.visibilityChangeEventName,(()=>{"hidden"===document.visibilityState?TimeMe.instance.triggerUserHasLeftThePage():TimeMe.instance.triggerUserHasReturned()}),!1),window.addEventListener("blur",(()=>{TimeMe.instance.triggerUserHasGoneIdle()})),window.addEventListener("focus",(()=>{TimeMe.instance.triggerUserHasReturned()})))}userActivityDetected(){this.isUserCurrentlyIdle&&this.triggerUserHasReturned(),this.resetIdleCountdown()}resetIdleCountdown(){this.isUserCurrentlyIdle=!1,this.currentIdleTimeMs=0}callWhenUserLeaves(e,t){let i=localStorage.getItem("userLeftCallbacks")||"[]";i=JSON.parse(i),i.push({callback:e,numberOfTimesToInvoke:t}),localStorage.setItem("userLeftCallbacks",JSON.stringify(i))}callWhenUserReturns(e,t){let i=localStorage.getItem("userReturnCallbacks")||"[]";i=JSON.parse(i),i.push({callback:e,numberOfTimesToInvoke:t}),localStorage.setItem("userReturnCallbacks",JSON.stringify(i))}triggerUserHasReturned(){if(!this.isUserCurrentlyOnPage){this.isUserCurrentlyOnPage=!0,this.resetIdleCountdown();let e=localStorage.getItem("userReturnCallbacks")||"[]";e=JSON.parse(e);for(let t=0;t<e.length;t++){let i=e[t],s=i.numberOfTimesToInvoke;(isNaN(s)||void 0===s||s>0)&&(i.numberOfTimesToInvoke-=1,i.callback()),e[t]=i,localStorage.setItem("userReturnCallbacks",JSON.stringify(e))}}this.startTimer()}callAfterTimeElapsedInSeconds(e,t){let i=localStorage.getItem("timeElapsedCallbacks")||"[]";i=JSON.parse(i),i.push({timeInSeconds:e,callback:t,pending:!0}),localStorage.setItem("timeElapsedCallbacks",JSON.stringify(i))}checkIdleState(){let e=localStorage.getItem("timeElapsedCallbacks")||"{}";e=JSON.parse(e);for(let t=0;t<e.length;t++)e[t].pending&&this.getTimeOnCurrentPageInSeconds()>e[t].timeInSeconds&&(e[t].callback(),e[t].pending=!1);localStorage.setItem("timeElapsedCallbacks",JSON.stringify(e)),!1===this.isUserCurrentlyIdle&&this.currentIdleTimeMs>this.idleTimeoutMs?(this.isUserCurrentlyIdle=!0,TimeMe.instance.triggerUserHasGoneIdle()):this.currentIdleTimeMs+=this.checkIdleStateRateMs}listForIdleEvents(){"undefined"!=typeof document&&(document.addEventListener("mousemove",(()=>{TimeMe.instance.userActivityDetected()})),document.addEventListener("keyup",(()=>{TimeMe.instance.userActivityDetected()})),document.addEventListener("touchstart",(()=>{TimeMe.instance.userActivityDetected()})),window.addEventListener("scroll",(()=>{TimeMe.instance.userActivityDetected()})),setInterval((()=>{!0!==this.isUserCurrentlyIdle&&TimeMe.instance.checkIdleState()}),this.checkIdleStateRateMs))}initialize(e){let t,i=this.idleTimeoutMs||30,s=this.currentPageName||"default-page-name",n=!0,r=!0;e&&(i=e.idleTimeoutInSeconds||i,s=e.currentPageName||s,t=e.initialStartTime,!1===e.trackWhenUserLeavesPage&&(n=!1),!1===e.trackWhenUserGoesIdle&&(r=!1)),this.setIdleDurationInSeconds(i),this.setCurrentPageName(s),this.listenForVisibilityEvents(n,r),"visible"===document.visibilityState&&this.startTimer(void 0,t)}}let timer=new TimeMe,current_page_identifier=btoa(document.location.href.split("#")[0]);function encrypt(e){let t=JSON.stringify(e),i=btoa(t),s=i.substring(0,10),n=i.substring(10),r=generateRandomString(1);return chunk(s,3).join(r)+n}function generateRandomString(e=40){let t="",i="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";for(let s=0;s<e;s++)t+=i.charAt(Math.floor(62*Math.random()));return t}function chunk(e,t){let i,s,n=[];for(i=0,s=e.length;i<s;i+=t)n.push(e.substr(i,t));return n}function deleteAllData(){localStorage.removeItem("startStopTimes"),localStorage.removeItem("timeElapsedCallbacks"),localStorage.removeItem("userReturnCallbacks"),localStorage.removeItem("userLeftCallbacks"),localStorage.removeItem("pageViewEvents")}timer.initialize({currentPageName:current_page_identifier,idleTimeoutInSeconds:30});